<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holy Cow! - Beef Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 15px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 25px 0;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border-radius: 15px;
            margin: -15px -15px 25px -15px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 500;
        }

        .camera-section {
            background: #f8fafc;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid #e2e8f0;
            position: relative;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 280px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .viewfinder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 120px;
            border: 3px solid #10b981;
            border-radius: 12px;
            z-index: 10;
        }

        .viewfinder::before,
        .viewfinder::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #10b981;
        }

        .viewfinder::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .viewfinder::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            animation: scan-animation 2s linear infinite;
        }

        @keyframes scan-animation {
            0% { transform: translateY(0); }
            100% { transform: translateY(120px); }
        }

        .camera-status {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-start {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-start:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-stop:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .manual-section {
            background: #f1f5f9;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #cbd5e0;
        }

        .manual-section h3 {
            margin-bottom: 15px;
            color: #1e293b;
            font-size: 18px;
        }

        .manual-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .manual-input input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .manual-input input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-check {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-check:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .result {
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 3px solid transparent;
        }

        .result.safe {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }

        .result.unsafe {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #7f1d1d;
            border-color: #ef4444;
        }

        .result.loading {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e3a8a;
            border-color: #3b82f6;
        }

        .result.error {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: #7c2d12;
            border-color: #f97316;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ingredients-box {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .ingredients-box h4 {
            margin-bottom: 10px;
            color: #374151;
            font-size: 16px;
            text-align: center;
        }

        .ingredients-list {
            line-height: 1.6;
            color: #4b5563;
        }

        .beef-found {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            margin: 2px;
            display: inline-block;
            border: 2px solid #dc2626;
        }

        .database-status {
            font-size: 12px;
            color: #6b7280;
            margin-top: 10px;
            text-align: center;
            font-style: italic;
        }

        .karma-message {
            font-size: 20px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .gods-watching {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .troubleshooting {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .troubleshooting h4 {
            color: #92400e;
            margin-bottom: 12px;
        }

        .troubleshooting ul {
            list-style: none;
            padding: 0;
        }

        .troubleshooting li {
            color: #78350f;
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .troubleshooting li::before {
            content: "⚠️";
            position: absolute;
            left: 0;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .camera-container {
                height: 240px;
            }
            
            .viewfinder {
                width: 200px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐄 Holy Cow!</h1>
            <p>Sacred Scanner • Beef Detector • Karma Protection</p>
        </div>

        <div class="camera-section">
            <div class="camera-container">
                <video id="cameraVideo" autoplay playsinline muted></video>
                <div class="viewfinder">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="camera-status" id="cameraStatus">Beef scanner ready</div>
            <div class="camera-controls">
                <button id="startCamera" class="btn btn-start">Start Scan</button>
                <button id="stopCamera" class="btn btn-stop" disabled>Stop Scan</button>
            </div>
        </div>

        <div class="manual-section">
            <h3>📝 Manual Barcode Entry</h3>
            <div class="manual-input">
                <input type="text" id="manualBarcode" placeholder="Enter barcode for divine judgment..." maxlength="20">
                <button id="checkManual" class="btn-check">Detect</button>
            </div>
        </div>

        <div id="result" class="camera-status">
            Ready for beef scanning! Point camera at barcode or enter manually above.
        </div>
    </div>

    <script>
        class HolyCowScanner {
            constructor() {
                this.isScanning = false;
                this.stream = null;
                this.lastScanTime = 0;
                
                this.beefKeywords = [
                    // English
                    'beef', 'bovine', 'cattle', 'cow', 'bull', 'steer', 'veal',
                    'beef extract', 'beef fat', 'beef tallow', 'beef stock', 
                    'beef broth', 'beef gelatin', 'beef protein', 'beef powder',
                    'meat extract', 'meat fat', 'meat stock', 'meat broth',
                    // Japanese
                    '牛肉', '牛', 'ビーフ', '牛脂', '牛エキス', '牛骨', '牛由来',
                    '和牛', '黒毛和牛', '牛すじ', '牛ひき肉', '牛バラ', '牛もも',
                    '牛ロース', '牛カルビ', '牛タン', '牛ホルモン',
                    // Other languages
                    'boeuf', 'rind', 'manzo', 'carne de res', 'carne de vaca',
                    'rundvlees', 'nötkött', 'okse', 'говядина'
                ];
                
                this.databases = [
                    {
                        name: "Open Food Facts",
                        url: (barcode) => `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`,
                        parser: this.parseOpenFoodFacts.bind(this)
                    },
                    {
                        name: "Go-UPC",
                        url: (barcode) => `https://go-upc.com/api/v1/code/${barcode}`,
                        parser: this.parseGoUPC.bind(this)
                    }
                ];
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkBrowserSupport();
            }

            setupEventListeners() {
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCamera').addEventListener('click', () => this.stopCamera());
                document.getElementById('checkManual').addEventListener('click', () => this.checkManualBarcode());
                
                document.getElementById('manualBarcode').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.checkManualBarcode();
                });

                document.getElementById('manualBarcode').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }

            checkBrowserSupport() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showResult('❌ Camera not supported in this browser. The gods require Chrome, Firefox, or Safari.', 'error');
                    document.getElementById('startCamera').disabled = true;
                    return false;
                }
                
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    this.showResult('⚠️ Divine camera requires HTTPS. Please use a secure connection blessed by the digital gods.', 'error');
                    this.showTroubleshooting();
                    return false;
                }
                
                return true;
            }

            async startCamera() {
                if (!this.checkBrowserSupport()) return;

                try {
                    this.updateStatus('🔄 Awakening divine camera...');
                    this.showResult('Summoning beef scanner...', 'loading');

                    if (this.stream) {
                        this.stopCamera();
                    }

                    const constraints = [
                        { video: { facingMode: { exact: 'environment' }, width: { ideal: 640 }, height: { ideal: 480 } } },
                        { video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } },
                        { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } },
                        { video: { width: { ideal: 640 }, height: { ideal: 480 } } },
                        { video: true }
                    ];

                    let stream = null;
                    for (const constraint of constraints) {
                        try {
                            stream = await navigator.mediaDevices.getUserMedia(constraint);
                            console.log('Divine camera blessed with constraint:', constraint);
                            break;
                        } catch (e) {
                            console.log('Divine constraint failed:', constraint, e.message);
                        }
                    }

                    if (!stream) {
                        throw new Error('The gods have not blessed this camera configuration');
                    }

                    this.stream = stream;
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    
                    await new Promise((resolve) => {
                        video.onloadedmetadata = resolve;
                    });

                    await video.play();
                    await this.initializeQuagga(video);

                    this.isScanning = true;
                    document.getElementById('startCamera').disabled = true;
                    document.getElementById('stopCamera').disabled = false;
                    this.updateStatus('🐄 Beef scanner active - seek the sacred codes');
                    this.showResult('📱 Holy scanner active! Point at a barcode for divine judgment', 'loading');

                } catch (error) {
                    console.error('Divine camera error:', error);
                    this.showResult(`❌ Divine Camera Error: ${error.message}`, 'error');
                    this.showTroubleshooting();
                    this.updateStatus('❌ The gods are displeased');
                }
            }

            initializeQuagga(videoElement) {
                return new Promise((resolve, reject) => {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: videoElement,
                            constraints: {
                                width: { min: 320, max: 800 },
                                height: { min: 240, max: 600 }
                            }
                        },
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader", 
                                "ean_8_reader",
                                "code_39_reader",
                                "codabar_reader"
                            ]
                        },
                        locate: true,
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        }
                    }, (err) => {
                        if (err) {
                            reject(err);
                            return;
                        }
                        
                        Quagga.start();
                        
                        Quagga.onDetected((result) => {
                            const now = Date.now();
                            if (now - this.lastScanTime < 3000) return;
                            
                            this.lastScanTime = now;
                            const code = result.codeResult.code;
                            
                            if (code && code.length >= 8) {
                                console.log('Sacred barcode detected:', code);
                                this.checkProductAcrossDatabases(code);
                            }
                        });
                        
                        resolve();
                    });
                });
            }

            stopCamera() {
                if (this.isScanning) {
                    try {
                        Quagga.stop();
                    } catch (e) {
                        console.log('Quagga divine stop error:', e);
                    }
                    this.isScanning = false;
                }

                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }

                const video = document.getElementById('cameraVideo');
                video.srcObject = null;

                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                this.updateStatus('📷 Beef scanner resting');
                this.showResult('Scanner blessed into rest. Click "Start Beef Scan" to resume.', 'error');
            }

            checkManualBarcode() {
                const barcode = document.getElementById('manualBarcode').value.trim();
                if (!barcode) {
                    this.showResult('⚠️ Please offer a barcode to the beef scanner', 'error');
                    return;
                }
                
                if (barcode.length < 8) {
                    this.showResult('⚠️ Sacred barcodes require at least 8 digits for divine judgment', 'error');
                    return;
                }

                this.checkProductAcrossDatabases(barcode);
            }

            async checkProductAcrossDatabases(barcode) {
                this.showResult(`🔍 Consulting divine databases for barcode: ${barcode}`, 'loading');
                this.updateStatus('🔍 Seeking divine knowledge...');

                for (let i = 0; i < this.databases.length; i++) {
                    const db = this.databases[i];
                    
                    try {
                        console.log(`Consulting ${db.name} for divine wisdom...`);
                        
                        const response = await fetch(db.url(barcode), {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'HolyCowScanner/1.0',
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            console.log(`${db.name} divine response error: ${response.status}`);
                            continue;
                        }

                        const data = await response.json();
                        const productInfo = db.parser(data);

                        if (productInfo) {
                            console.log(`Divine wisdom found in ${db.name}:`, productInfo);
                            this.analyzeProduct(productInfo, barcode, db.name);
                            return;
                        }

                    } catch (error) {
                        console.log(`${db.name} divine consultation failed:`, error.message);
                        continue;
                    }
                }

                this.showProductNotFound(barcode);
            }

            parseOpenFoodFacts(data) {
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    return {
                        name: product.product_name || product.product_name_en || product.product_name_ja || 'Divine Product',
                        ingredients: product.ingredients_text || product.ingredients_text_en || product.ingredients_text_ja || '',
                        brand: product.brands || ''
                    };
                }
                return null;
            }

            parseGoUPC(data) {
                if (data && data.product) {
                    return {
                        name: data.product.name || 'Divine Product',
                        ingredients: data.product.description || '',
                        brand: data.product.brand || ''
                    };
                }
                return null;
            }

            analyzeProduct(productInfo, barcode, databaseName) {
                const { name, ingredients, brand } = productInfo;
                const ingredientsLower = ingredients.toLowerCase();
                
                const beefFound = this.findBeefIngredients(ingredientsLower);
                const hasBeef = beefFound.length > 0;

                let resultHtml = `<div class="karma-message">`;
                
                if (hasBeef) {
                    resultHtml += `<div class="gods-watching">🐄 Contains BEEF! The Gods are watching! 👁️</div>`;
                } else {
                    resultHtml += `<div>✨ NO cow harmed. Karma earned! 🕉️</div>`;
                }

                resultHtml += `</div>`;
                
                resultHtml += `<strong>${name}</strong><br>`;
                if (brand) resultHtml += `<small>Brand: ${brand}</small><br>`;
                resultHtml += `<small>Barcode: ${barcode}</small>`;

                if (ingredients.trim()) {
                    resultHtml += `<div class="ingredients-box">
                        <h4>📋 Sacred Ingredients</h4>
                        <div class="ingredients-list">${this.formatIngredients(ingredients, beefFound)}</div>
                    </div>`;
                }

                resultHtml += `<div class="database-status">Divine wisdom from: ${databaseName}</div>`;

                this.showResult(resultHtml, hasBeef ? 'unsafe' : 'safe');
                this.updateStatus(hasBeef ? '🐄 Beef detected - Gods watching!' : '✨ No beef - Karma earned!');

                document.getElementById('manualBarcode').value = '';
            }

            formatIngredients(ingredients, beefFound) {
                if (!ingredients) return 'No ingredients listed in divine records';

                let formatted = ingredients;
                
                // Highlight beef ingredients
                beefFound.forEach(beefTerm => {
                    const regex = new RegExp(`(${beefTerm})`, 'gi');
                    formatted = formatted.replace(regex, '<span class="beef-found">$1</span>');
                });

                return formatted;
            }

            findBeefIngredients(text) {
                if (!text) return [];
                
                return this.beefKeywords.filter(keyword => 
                    text.includes(keyword.toLowerCase())
                );
            }

            showProductNotFound(barcode) {
                const resultHtml = `
                    <div class="karma-message">
                        <div>🔮 Product Beyond Divine Knowledge</div>
                    </div>
                    <strong>Sacred Product Unknown</strong><br>
                    <small>Barcode: ${barcode}</small><br><br>
                    ⚠️ <strong>NOT IN DIVINE DATABASES</strong><br>
                    <small>Please consult the physical sacred text (packaging) for ingredient wisdom.</small>
                    <div class="database-status">Consulted all divine databases - product remains mysterious</div>
                `;
                this.showResult(resultHtml, 'error');
                this.updateStatus('🔮 Product beyond divine knowledge');
                
                document.getElementById('manualBarcode').value = '';
            }

            showResult(html, type) {
                const result = document.getElementById('result');
                result.className = `result ${type}`;
                result.innerHTML = html;
            }

            updateStatus(text) {
                document.getElementById('cameraStatus').textContent = text;
            }

            showTroubleshooting() {
                const troubleshooting = `
                    <div class="troubleshooting">
                        <h4>🔧 Divine Camera Troubleshooting</h4>
                        <ul>
                            <li>Ensure you're using <strong>HTTPS</strong> or localhost blessed by the gods</li>
                            <li>Click "Allow" when the digital gods request camera permission</li>
                            <li>Close other divine apps that might be using the sacred camera</li>
                            <li>Use Chrome, Firefox, or Safari - browsers blessed by the divine</li>
                            <li>On mobile: Check browser camera permissions in sacred settings</li>
                            <li>Use manual barcode entry as divine backup</li>
                        </ul>
                    </div>
                `;
                document.getElementById('result').innerHTML += troubleshooting;
            }
        }

        // Awaken the beef scanner when the sacred page loads
        document.addEventListener('DOMContentLoaded', () => {
            new HolyCowScanner();
        });
    </script>
</body>
</html>
